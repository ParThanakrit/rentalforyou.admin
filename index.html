<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rental For You</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-card: #242424;
            --bg-hover: #2d2d2d;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666;
            --accent: #c9a962;
            --accent-hover: #d4b872;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
            --info: #60a5fa;
            --border: #333;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Prompt', sans-serif; background: var(--bg-dark); color: var(--text-primary); min-height: 100vh; }
        
        .header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 35px; height: 35px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .logo span { color: var(--accent); }
        
        .nav-tabs { display: flex; gap: 5px; background: var(--bg-card); padding: 10px 30px; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .nav-tab { padding: 12px 24px; background: transparent; border: none; color: var(--text-secondary); font-family: 'Prompt', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; border-radius: 8px; transition: all 0.2s; white-space: nowrap; }
        .nav-tab:hover { background: var(--bg-hover); color: var(--text-primary); }
        .nav-tab.active { background: var(--accent); color: var(--bg-dark); }
        
        .main { padding: 30px; max-width: 1600px; margin: 0 auto; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        .card-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .card-title { font-size: 1.1rem; font-weight: 600; }
        .card-body { padding: 20px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-family: 'Prompt', sans-serif; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: var(--bg-dark); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        .btn-toggle { background: var(--bg-hover); color: var(--text-secondary); border: 2px solid var(--border); }
        .btn-toggle:hover { border-color: var(--accent); color: var(--text-primary); }
        .btn-toggle.active { background: var(--accent); color: var(--bg-dark); border-color: var(--accent); }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: 'Prompt', sans-serif; font-size: 0.95rem; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; }
        .stat-icon { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-bottom: 15px; }
        .stat-icon.gold { background: rgba(201, 169, 98, 0.2); }
        .stat-icon.green { background: rgba(74, 222, 128, 0.2); }
        .stat-icon.blue { background: rgba(96, 165, 250, 0.2); }
        .stat-icon.red { background: rgba(248, 113, 113, 0.2); }
        .stat-value { font-size: 1.8rem; font-weight: 700; font-family: 'Space Mono', monospace; }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; }
        
        .calendar-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .calendar-card { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
        .calendar-card-header { padding: 15px; background: var(--bg-hover); border-bottom: 1px solid var(--border); }
        .calendar-card-title { font-weight: 600; }
        .calendar-card-title .code { font-family: 'Space Mono', monospace; font-size: 0.85rem; color: var(--accent); margin-right: 8px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; padding: 10px; }
        .calendar-header-day { text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); padding: 8px 0; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border-radius: 6px; background: var(--bg-dark); }
        .calendar-day.empty { background: transparent; }
        .calendar-day.past { color: var(--text-muted); opacity: 0.5; }
        .calendar-day.today { border: 2px solid var(--accent); }
        .calendar-day.booked { background: var(--danger); color: white; }
        
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg-dark); margin-bottom: 20px; border-radius: 10px; }
        .calendar-nav-btn { width: 35px; height: 35px; border: none; background: var(--bg-hover); color: var(--text-primary); border-radius: 6px; cursor: pointer; font-size: 1rem; }
        .calendar-nav-btn:hover { background: var(--accent); color: var(--bg-dark); }
        .calendar-month-year { font-weight: 600; }
        
        .calendar-legend { display: flex; gap: 20px; padding: 15px; background: var(--bg-card); border-radius: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .legend-dot { width: 16px; height: 16px; border-radius: 4px; }
        .legend-dot.available { background: var(--bg-dark); border: 1px solid var(--border); }
        .legend-dot.booked { background: var(--danger); }
        
        .block-form { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); padding: 25px; margin-bottom: 20px; }
        .block-form-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }
        
        .blocks-list { max-height: 400px; overflow-y: auto; }
        .block-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px; }
        .block-code { font-family: 'Space Mono', monospace; color: var(--accent); font-weight: 600; }
        .block-dates { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; }
        .block-type { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; margin-left: 10px; }
        .block-type.order { background: var(--info); color: white; }
        .block-type.custom { background: var(--warning); color: var(--bg-dark); }
        
        .calculator-card { background: linear-gradient(135deg, var(--bg-card) 0%, #2a2520 100%); border: 1px solid var(--accent); }
        .price-result { background: var(--bg-dark); border-radius: 10px; padding: 20px; margin-top: 20px; }
        .price-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .price-row:last-child { border-bottom: none; }
        .price-row.total { font-size: 1.2rem; font-weight: 700; color: var(--accent); border-top: 2px solid var(--accent); margin-top: 10px; padding-top: 15px; }
        .price-label { color: var(--text-secondary); }
        .price-value { font-weight: 600; font-family: 'Space Mono', monospace; }
        
        .dress-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; max-height: 250px; overflow-y: auto; padding: 10px; background: var(--bg-dark); border-radius: 8px; }
        .dress-option { padding: 10px; background: var(--bg-hover); border: 2px solid transparent; border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; }
        .dress-option:hover { border-color: var(--border); }
        .dress-option.selected { border-color: var(--accent); background: rgba(201, 169, 98, 0.1); }
        .dress-option-code { font-family: 'Space Mono', monospace; font-weight: 600; color: var(--accent); font-size: 0.9rem; }
        .dress-option-name { font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .dress-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .dress-tag { background: var(--bg-hover); padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .dress-tag .remove { cursor: pointer; color: var(--danger); font-weight: bold; }
        
        .promo-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 15px; }
        .promo-item { display: flex; align-items: center; justify-content: space-between; padding: 20px; gap: 15px; flex-wrap: wrap; }
        .promo-info { flex: 1; min-width: 200px; }
        .promo-name { font-weight: 600; margin-bottom: 5px; }
        .promo-desc { font-size: 0.85rem; color: var(--text-secondary); }
        .promo-controls { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .promo-value { display: flex; align-items: center; gap: 8px; }
        .promo-value input { width: 70px; padding: 8px; text-align: center; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: 'Space Mono', monospace; }
        .promo-value input:focus { outline: none; border-color: var(--accent); }
        .promo-unit { font-size: 0.9rem; color: var(--text-secondary); }
        
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-dark); transition: 0.3s; border-radius: 26px; border: 1px solid var(--border); }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: var(--text-secondary); transition: 0.3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: var(--accent); border-color: var(--accent); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); background-color: var(--bg-dark); }
        
        .extra-discounts { margin-top: 15px; }
        .extra-discount-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-dark); border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .extra-discount-item input[type="text"] { flex: 1; min-width: 120px; padding: 8px 12px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: 'Prompt', sans-serif; }
        .extra-discount-item input[type="number"] { width: 70px; padding: 8px; text-align: center; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: 'Space Mono', monospace; }
        .extra-discount-item select { padding: 8px 12px; background: var(--bg-hover); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-family: 'Prompt', sans-serif; }
        
        .active-promos { background: rgba(201, 169, 98, 0.1); border: 1px solid var(--accent); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .active-promos-title { font-size: 0.85rem; color: var(--accent); margin-bottom: 10px; font-weight: 600; }
        .active-promo-tag { display: inline-block; background: var(--accent); color: var(--bg-dark); padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; margin: 3px; font-weight: 500; }
        
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar .form-input, .filter-bar .form-select { width: auto; min-width: 150px; }
        
        .toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 15px 20px; margin-top: 10px; display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .toast.info { border-left: 4px solid var(--info); }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--text-secondary); }
        .spinner { width: 30px; height: 30px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-right: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .header { padding: 15px; }
            .nav-tabs { padding: 10px 15px; }
            .main { padding: 15px; }
            .form-row { grid-template-columns: 1fr; }
            .calendar-container { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .promo-item { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <div class="logo-icon">üëó</div>
            <span>Rental</span> Admin
        </div>
        <button class="btn btn-secondary" onclick="refreshAll()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
    
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showPage('calendar', this)">üìÖ ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ß‡∏°</button>
        <button class="nav-tab" onclick="showPage('blocks', this)">üö´ ‡∏ö‡∏•‡πá‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button class="nav-tab" onclick="showPage('calculator', this)">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤</button>
        <button class="nav-tab" onclick="showPage('promo', this)">üéÅ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</button>
    </div>
    
    <div class="main">
        <!-- CALENDAR PAGE -->
        <div id="calendarPage" class="page active">
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-icon gold">üëó</div><div class="stat-value" id="statTotal">-</div><div class="stat-label">‡∏ä‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
                <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div class="stat-value" id="statAvailable">-</div><div class="stat-label">‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
                <div class="stat-card"><div class="stat-icon red">üìå</div><div class="stat-value" id="statBooked">-</div><div class="stat-label">‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>
                <div class="stat-card"><div class="stat-icon blue">üìã</div><div class="stat-value" id="statBlocks">-</div><div class="stat-label">‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
            </div>
            
            <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="changeGlobalMonth(-1)">‚óÄ</button>
                <span class="calendar-month-year" id="globalMonthYear"></span>
                <button class="calendar-nav-btn" onclick="changeGlobalMonth(1)">‚ñ∂</button>
            </div>
            
            <div class="calendar-legend">
                <div class="legend-item"><div class="legend-dot available"></div> ‡∏ß‡πà‡∏≤‡∏á</div>
                <div class="legend-item"><div class="legend-dot booked"></div> ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á</div>
                <div class="legend-item"><div class="legend-dot" style="border: 2px solid var(--accent);"></div> ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            </div>
            
            <div class="filter-bar">
                <input type="text" class="form-input" id="calendarSearch" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∏‡∏î..." onkeyup="filterCalendars()">
                <select class="form-select" id="calendarBrandFilter" onchange="filterCalendars()"><option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option></select>
            </div>
            
            <div class="calendar-container" id="calendarsGrid"><div class="loading"><div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div>
        </div>
        
        <!-- BLOCKS PAGE -->
        <div id="blocksPage" class="page">
            <div class="form-row">
                <div class="block-form">
                    <div class="block-form-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</div>
                    <div class="form-group"><label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î</label><select class="form-select" id="blockDressCode"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î --</option></select></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏•‡πá‡∏≠‡∏Å</label><input type="date" class="form-input" id="blockStartDate"></div>
                        <div class="form-group"><label class="form-label">‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ö‡∏•‡πá‡∏≠‡∏Å</label><input type="date" class="form-input" id="blockEndDate"></div>
                    </div>
                    <div class="form-group"><label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select class="form-select" id="blockType"><option value="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option><option value="‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option><option value="‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°">‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°</option><option value="‡∏ã‡∏±‡∏Å/‡∏£‡∏µ‡∏î">‡∏ã‡∏±‡∏Å/‡∏£‡∏µ‡∏î</option><option value="‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤">‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤</option></select></div>
                    <button class="btn btn-primary" onclick="addBlock()">üö´ ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</button>
                </div>
                
                <div class="card" style="flex: 1;">
                    <div class="card-header">
                        <div class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        <select class="form-select" style="width: auto;" id="blockFilterType" onchange="filterBlocks()"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</option><option value="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option><option value="‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°">‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°</option><option value="‡∏ã‡∏±‡∏Å/‡∏£‡∏µ‡∏î">‡∏ã‡∏±‡∏Å/‡∏£‡∏µ‡∏î</option></select>
                    </div>
                    <div class="card-body"><div class="blocks-list" id="blocksList"><div class="loading"><div class="spinner"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div></div></div>
                </div>
            </div>
        </div>
        
        <!-- CALCULATOR PAGE -->
        <div id="calculatorPage" class="page">
            <div class="active-promos" id="activePromosDisplay">
                <div class="active-promos-title">üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
                <div id="activePromoTags"></div>
            </div>
            
            <div class="form-row">
                <div class="card calculator-card">
                    <div class="card-header"><div class="card-title">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏ä‡πà‡∏≤</div></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î)</label>
                            <div class="dress-selector" id="dressSelector"></div>
                            <div class="dress-tags" id="selectedDresses"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</label><select class="form-select" id="calcDays" onchange="calculatePrice()"><option value="1">1 ‡∏ß‡∏±‡∏ô</option><option value="3" selected>3 ‡∏ß‡∏±‡∏ô</option><option value="5">5 ‡∏ß‡∏±‡∏ô</option></select></div>
                            <div class="form-group"><label class="form-label">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤?</label><select class="form-select" id="calcOldCustomer" onchange="calculatePrice()"><option value="false">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà</option><option value="true">‡πÉ‡∏ä‡πà</option></select></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡πÄ‡∏®‡∏©</label>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button type="button" class="btn btn-toggle" id="btnFreeDeposit" onclick="toggleFreeDeposit()">üí∞ ‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</button>
                                <button type="button" class="btn btn-toggle" id="btnFreeShipping" onclick="toggleFreeShipping()">üöö ‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</button>
                            </div>
                        </div>
                        <div class="form-group" id="extraDiscountCheckboxes" style="display: none;">
                            <label class="form-label">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
                            <div id="extraDiscountOptions"></div>
                        </div>
                        <div class="price-result" id="priceResult" style="display: none;">
                            <div class="price-row"><span class="price-label">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏ä‡∏∏‡∏î</span><span class="price-value" id="priceSubtotal">0 ‡∏ø</span></div>
                            <div id="discountRows"></div>
                            <div class="price-row"><span class="price-label">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</span><span class="price-value" id="priceShipping">0 ‡∏ø</span></div>
                            <div class="price-row"><span class="price-label">‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="price-value" id="priceRental">0 ‡∏ø</span></div>
                            <div class="price-row"><span class="price-label" id="depositLabel">‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</span><span class="price-value" id="priceDeposit">0 ‡∏ø</span></div>
                            <div class="price-row total"><span class="price-label">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span><span class="price-value" id="priceTotal">0 ‡∏ø</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><div class="card-title">üìå ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div></div>
                    <div class="card-body" id="currentRulesDisplay"><div class="loading"><div class="spinner"></div></div></div>
                </div>
            </div>
        </div>
        
        <!-- PROMO PAGE -->
        <div id="promoPage" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üéÅ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô & ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</div>
                    <button class="btn btn-primary" onclick="savePromoSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
                <div class="card-body">
                    <!-- Multi Dress Discount -->
                    <div class="promo-card">
                        <div class="promo-item">
                            <div class="promo-info"><div class="promo-name">üëó ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÄ‡∏ä‡πà‡∏≤‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î</div><div class="promo-desc">‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div></div>
                            <div class="promo-controls">
                                <div class="promo-value"><span>‡πÄ‡∏ä‡πà‡∏≤‡∏Ñ‡∏£‡∏ö</span><input type="number" id="promoMultiQty" value="3" min="2" max="10"><span class="promo-unit">‡∏ä‡∏∏‡∏î ‡∏•‡∏î</span><input type="number" id="promoMultiDiscount" value="10" min="0" max="50"><span class="promo-unit">%</span></div>
                                <label class="toggle-switch"><input type="checkbox" id="promoMultiEnabled" checked><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Old Customer Discount -->
                    <div class="promo-card">
                        <div class="promo-item">
                            <div class="promo-info"><div class="promo-name">üíù ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</div><div class="promo-desc">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏ä‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô</div></div>
                            <div class="promo-controls">
                                <div class="promo-value"><span>‡∏•‡∏î</span><input type="number" id="promoOldCustomerDiscount" value="5" min="0" max="30"><span class="promo-unit">%</span></div>
                                <label class="toggle-switch"><input type="checkbox" id="promoOldCustomerEnabled" checked><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Free Shipping -->
                    <div class="promo-card">
                        <div class="promo-item">
                            <div class="promo-info"><div class="promo-name">üöö ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ</div><div class="promo-desc">‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πà‡∏≤‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</div></div>
                            <div class="promo-controls">
                                <div class="promo-value"><span>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥</span><input type="number" id="promoShippingCost" value="35" min="0" max="200"><span class="promo-unit">‡∏ø</span><span style="margin-left: 15px;">‡∏ü‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠</span><input type="number" id="promoFreeShipQty" value="2" min="1" max="10"><span class="promo-unit">‡∏ä‡∏∏‡∏î</span></div>
                                <label class="toggle-switch"><input type="checkbox" id="promoFreeShipEnabled" checked><span class="toggle-slider"></span></label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Deposit Calculation -->
                    <div class="promo-card">
                        <div class="promo-item">
                            <div class="promo-info"><div class="promo-name">üí∞ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</div><div class="promo-desc">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</div></div>
                            <div class="promo-controls">
                                <select class="form-select" id="promoDepositType" style="width: auto;" onchange="toggleDepositOptions()">
                                    <option value="price3">‡∏£‡∏≤‡∏Ñ‡∏≤ 3 ‡∏ß‡∏±‡∏ô</option>
                                    <option value="price1">‡∏£‡∏≤‡∏Ñ‡∏≤ 1 ‡∏ß‡∏±‡∏ô</option>
                                    <option value="fixed">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
                                    <option value="percent">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤</option>
                                </select>
                                <div class="promo-value" id="depositFixedValue" style="display: none;"><input type="number" id="promoDepositFixed" value="500" min="0"><span class="promo-unit">‡∏ø/‡∏ä‡∏∏‡∏î</span></div>
                                <div class="promo-value" id="depositPercentValue" style="display: none;"><input type="number" id="promoDepositPercent" value="100" min="0" max="200"><span class="promo-unit">%</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extra Custom Discounts -->
                    <div class="promo-card">
                        <div class="promo-item" style="flex-direction: column; align-items: stretch;">
                            <div class="promo-info" style="margin-bottom: 15px;"><div class="promo-name">‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div><div class="promo-desc">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡∏°‡πÄ‡∏õ‡∏ç‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤)</div></div>
                            <div class="extra-discounts" id="extraDiscounts"></div>
                            <button class="btn btn-secondary" onclick="addExtraDiscount()" style="margin-top: 10px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzpi3AUgVDIgSdm2SHYhqbdI819Xq9DWkFAfvXLe3c8U-H-tyH-ZDSp19nMu6D-hCxy/exec';
        const PROMO_STORAGE_KEY = 'rental_promo_settings';
        
        let dresses = [], blocks = [];
        let globalMonth = new Date().getMonth(), globalYear = new Date().getFullYear();
        let selectedDressesForCalc = [], selectedExtraDiscounts = [];
        let isFreeDeposit = false, isFreeShipping = false;
        
        function toggleFreeDeposit() {
            isFreeDeposit = !isFreeDeposit;
            document.getElementById('btnFreeDeposit').classList.toggle('active', isFreeDeposit);
            calculatePrice();
        }
        
        function toggleFreeShipping() {
            isFreeShipping = !isFreeShipping;
            document.getElementById('btnFreeShipping').classList.toggle('active', isFreeShipping);
            calculatePrice();
        }
        
        let promoSettings = {
            multiDress: { enabled: true, minQty: 3, discount: 10 },
            oldCustomer: { enabled: true, discount: 5 },
            shipping: { enabled: true, cost: 35, freeQty: 2 },
            deposit: { type: 'price3', fixedAmount: 500, percent: 100 },
            extraDiscounts: []
        };
        
        async function init() {
            loadPromoSettings();
            await Promise.all([loadDresses(), loadBlocks()]);
            renderAll();
        }
        
        function loadPromoSettings() {
            try {
                const saved = localStorage.getItem(PROMO_STORAGE_KEY);
                if (saved) promoSettings = JSON.parse(saved);
            } catch (e) {}
            applyPromoSettingsToUI();
        }
        
        function savePromoSettings() {
            promoSettings.multiDress.enabled = document.getElementById('promoMultiEnabled').checked;
            promoSettings.multiDress.minQty = parseInt(document.getElementById('promoMultiQty').value) || 3;
            promoSettings.multiDress.discount = parseInt(document.getElementById('promoMultiDiscount').value) || 10;
            promoSettings.oldCustomer.enabled = document.getElementById('promoOldCustomerEnabled').checked;
            promoSettings.oldCustomer.discount = parseInt(document.getElementById('promoOldCustomerDiscount').value) || 5;
            promoSettings.shipping.enabled = document.getElementById('promoFreeShipEnabled').checked;
            promoSettings.shipping.cost = parseInt(document.getElementById('promoShippingCost').value) || 35;
            promoSettings.shipping.freeQty = parseInt(document.getElementById('promoFreeShipQty').value) || 2;
            promoSettings.deposit.type = document.getElementById('promoDepositType').value;
            promoSettings.deposit.fixedAmount = parseInt(document.getElementById('promoDepositFixed').value) || 500;
            promoSettings.deposit.percent = parseInt(document.getElementById('promoDepositPercent').value) || 100;
            
            promoSettings.extraDiscounts = [];
            document.querySelectorAll('.extra-discount-item').forEach(item => {
                const name = item.querySelector('.extra-name').value;
                const value = parseInt(item.querySelector('.extra-value').value) || 0;
                const type = item.querySelector('.extra-type').value;
                if (name && value > 0) promoSettings.extraDiscounts.push({ name, value, type });
            });
            
            try {
                localStorage.setItem(PROMO_STORAGE_KEY, JSON.stringify(promoSettings));
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (e) { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error'); }
            
            renderCurrentRules();
            renderActivePromos();
            renderExtraDiscountCheckboxes();
            calculatePrice();
        }
        
        function applyPromoSettingsToUI() {
            document.getElementById('promoMultiEnabled').checked = promoSettings.multiDress.enabled;
            document.getElementById('promoMultiQty').value = promoSettings.multiDress.minQty;
            document.getElementById('promoMultiDiscount').value = promoSettings.multiDress.discount;
            document.getElementById('promoOldCustomerEnabled').checked = promoSettings.oldCustomer.enabled;
            document.getElementById('promoOldCustomerDiscount').value = promoSettings.oldCustomer.discount;
            document.getElementById('promoFreeShipEnabled').checked = promoSettings.shipping.enabled;
            document.getElementById('promoShippingCost').value = promoSettings.shipping.cost;
            document.getElementById('promoFreeShipQty').value = promoSettings.shipping.freeQty;
            document.getElementById('promoDepositType').value = promoSettings.deposit.type;
            document.getElementById('promoDepositFixed').value = promoSettings.deposit.fixedAmount;
            document.getElementById('promoDepositPercent').value = promoSettings.deposit.percent;
            toggleDepositOptions();
            renderExtraDiscountsUI();
        }
        
        function toggleDepositOptions() {
            const type = document.getElementById('promoDepositType').value;
            document.getElementById('depositFixedValue').style.display = type === 'fixed' ? 'flex' : 'none';
            document.getElementById('depositPercentValue').style.display = type === 'percent' ? 'flex' : 'none';
        }
        
        function renderExtraDiscountsUI() {
            document.getElementById('extraDiscounts').innerHTML = promoSettings.extraDiscounts.map((d, idx) => 
                '<div class="extra-discount-item"><input type="text" class="extra-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î" value="' + d.name + '"><input type="number" class="extra-value" placeholder="0" value="' + d.value + '" min="0"><select class="extra-type"><option value="percent"' + (d.type === 'percent' ? ' selected' : '') + '>%</option><option value="fixed"' + (d.type === 'fixed' ? ' selected' : '') + '>‡∏ø</option></select><button class="btn btn-danger btn-sm" onclick="removeExtraDiscount(' + idx + ')">üóëÔ∏è</button></div>'
            ).join('');
        }
        
        function addExtraDiscount() {
            promoSettings.extraDiscounts.push({ name: '', value: 0, type: 'percent' });
            renderExtraDiscountsUI();
        }
        
        function removeExtraDiscount(idx) {
            promoSettings.extraDiscounts.splice(idx, 1);
            renderExtraDiscountsUI();
        }
        
        async function loadDresses() {
            try {
                const res = await fetch(API + '?action=list');
                const data = await res.json();
                if (data.success) dresses = data.data;
            } catch (e) { showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }
        
        async function loadBlocks() {
            try {
                const res = await fetch(API + '?action=getCalendarBlocks');
                const data = await res.json();
                if (data.success) blocks = data.blocks;
            } catch (e) { showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
        }
        
        async function addBlock() {
            const code = document.getElementById('blockDressCode').value;
            const startDate = document.getElementById('blockStartDate').value;
            const endDate = document.getElementById('blockEndDate').value;
            const type = document.getElementById('blockType').value;
            
            if (!code || !startDate || !endDate) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
            if (new Date(startDate) > new Date(endDate)) { showToast('‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'error'); return; }
            
            try {
                const res = await fetch(API + '?action=addCalendarBlock&dressCode=' + code + '&startDate=' + startDate + '&endDate=' + endDate + '&type=' + encodeURIComponent(type));
                const data = await res.json();
                if (data.success) {
                    showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('blockDressCode').value = '';
                    document.getElementById('blockStartDate').value = '';
                    document.getElementById('blockEndDate').value = '';
                    await loadBlocks();
                    renderAll();
                }
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
        }
        
        async function deleteBlock(blockId) {
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ?')) return;
            try {
                const res = await fetch(API + '?action=deleteCalendarBlock&id=' + blockId);
                const data = await res.json();
                if (data.success) { showToast('‡∏•‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success'); await loadBlocks(); renderAll(); }
            } catch (e) { showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error'); }
        }
        
        function renderAll() {
            renderStats();
            renderCalendars();
            renderBlocksList();
            renderDressSelector();
            populateFilters();
            renderCurrentRules();
            renderActivePromos();
            renderExtraDiscountCheckboxes();
        }
        
        function renderStats() {
            const today = formatDate(new Date());
            let bookedToday = 0;
            dresses.forEach(dress => {
                const isBooked = blocks.filter(b => b.dressCode === dress.code).some(block => {
                    const start = formatDate(new Date(block.startDate));
                    const end = formatDate(new Date(block.endDate));
                    return today >= start && today <= end;
                });
                if (isBooked) bookedToday++;
            });
            document.getElementById('statTotal').textContent = dresses.length;
            document.getElementById('statAvailable').textContent = dresses.length - bookedToday;
            document.getElementById('statBooked').textContent = bookedToday;
            document.getElementById('statBlocks').textContent = blocks.length;
        }
        
        function renderCalendars() {
            const container = document.getElementById('calendarsGrid');
            const search = document.getElementById('calendarSearch').value.toLowerCase();
            const brandFilter = document.getElementById('calendarBrandFilter').value;
            
            let filtered = dresses.filter(d => {
                const matchSearch = !search || d.code.toLowerCase().includes(search) || d.name.toLowerCase().includes(search);
                const matchBrand = !brandFilter || d.brand === brandFilter;
                return matchSearch && matchBrand;
            });
            
            if (!filtered.length) { container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--text-secondary);padding:40px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏î</p>'; return; }
            
            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            document.getElementById('globalMonthYear').textContent = months[globalMonth] + ' ' + (globalYear + 543);
            
            container.innerHTML = filtered.map(dress => {
                const dressBlocks = blocks.filter(b => b.dressCode === dress.code);
                return '<div class="calendar-card"><div class="calendar-card-header"><div class="calendar-card-title"><span class="code">' + dress.code + '</span>' + dress.name + '</div></div><div class="calendar-grid"><div class="calendar-header-day">‡∏≠‡∏≤</div><div class="calendar-header-day">‡∏à</div><div class="calendar-header-day">‡∏≠</div><div class="calendar-header-day">‡∏û</div><div class="calendar-header-day">‡∏û‡∏§</div><div class="calendar-header-day">‡∏®</div><div class="calendar-header-day">‡∏™</div>' + generateCalendarDays(dressBlocks) + '</div></div>';
            }).join('');
        }
        
        function generateCalendarDays(dressBlocks) {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const firstDay = new Date(globalYear, globalMonth, 1);
            const lastDay = new Date(globalYear, globalMonth + 1, 0);
            let html = '';
            for (let i = 0; i < firstDay.getDay(); i++) html += '<div class="calendar-day empty"></div>';
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const date = new Date(globalYear, globalMonth, d);
                const dateStr = formatDate(date);
                let classes = 'calendar-day';
                if (date < today) classes += ' past';
                else {
                    const isBooked = dressBlocks.some(block => {
                        const start = formatDate(new Date(block.startDate));
                        const end = formatDate(new Date(block.endDate));
                        return dateStr >= start && dateStr <= end;
                    });
                    if (isBooked) classes += ' booked';
                }
                if (date.getTime() === today.getTime()) classes += ' today';
                html += '<div class="' + classes + '">' + d + '</div>';
            }
            return html;
        }
        
        function renderBlocksList() {
            const container = document.getElementById('blocksList');
            const filterType = document.getElementById('blockFilterType').value;
            let filtered = filterType ? blocks.filter(b => b.type === filterType) : blocks;
            filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            if (!filtered.length) { container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏•‡πá‡∏≠‡∏Å</p>'; return; }
            container.innerHTML = filtered.map(block => '<div class="block-item"><div><span class="block-code">' + block.dressCode + '</span><span class="block-type ' + (block.type === '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' ? 'order' : 'custom') + '">' + block.type + '</span><div class="block-dates">üìÖ ' + formatDateThai(block.startDate) + ' - ' + formatDateThai(block.endDate) + '</div></div><button class="btn btn-danger btn-sm" onclick="deleteBlock(\'' + block.id + '\')">üóëÔ∏è ‡∏•‡∏ö</button></div>').join('');
        }
        
        function renderDressSelector() {
            document.getElementById('dressSelector').innerHTML = dresses.map(d => '<div class="dress-option ' + (selectedDressesForCalc.includes(d.code) ? 'selected' : '') + '" onclick="toggleDressSelection(\'' + d.code + '\')"><div class="dress-option-code">' + d.code + '</div><div class="dress-option-name">' + d.name + '</div></div>').join('');
            updateSelectedDressTags();
        }
        
        function updateSelectedDressTags() {
            const container = document.getElementById('selectedDresses');
            if (!selectedDressesForCalc.length) { container.innerHTML = '<span style="color:var(--text-muted);font-size:0.85rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î</span>'; return; }
            container.innerHTML = selectedDressesForCalc.map(code => '<div class="dress-tag"><span>' + code + '</span><span class="remove" onclick="removeDressSelection(\'' + code + '\')">&times;</span></div>').join('');
            calculatePrice();
        }
        
        function toggleDressSelection(code) {
            const idx = selectedDressesForCalc.indexOf(code);
            if (idx > -1) selectedDressesForCalc.splice(idx, 1);
            else selectedDressesForCalc.push(code);
            renderDressSelector();
        }
        
        function removeDressSelection(code) {
            selectedDressesForCalc = selectedDressesForCalc.filter(c => c !== code);
            renderDressSelector();
        }
        
        function populateFilters() {
            const brands = [...new Set(dresses.map(d => d.brand).filter(Boolean))];
            document.getElementById('calendarBrandFilter').innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå</option>' + brands.map(b => '<option value="' + b + '">' + b + '</option>').join('');
            document.getElementById('blockDressCode').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î --</option>' + dresses.map(d => '<option value="' + d.code + '">' + d.code + ' - ' + d.name + '</option>').join('');
        }
        
        function renderCurrentRules() {
            let html = '<div style="line-height:2;">';
            if (promoSettings.multiDress.enabled) html += '<p>üéÅ <strong>‡πÄ‡∏ä‡πà‡∏≤ ' + promoSettings.multiDress.minQty + ' ‡∏ä‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</strong> ‡∏•‡∏î ' + promoSettings.multiDress.discount + '%</p>';
            if (promoSettings.oldCustomer.enabled) html += '<p>üíù <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤</strong> ‡∏•‡∏î ' + promoSettings.oldCustomer.discount + '% ‡πÄ‡∏û‡∏¥‡πà‡∏°</p>';
            if (promoSettings.shipping.enabled) html += '<p>üöö <strong>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</strong> ' + promoSettings.shipping.cost + '‡∏ø (‡∏ü‡∏£‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πà‡∏≤ ' + promoSettings.shipping.freeQty + ' ‡∏ä‡∏∏‡∏î)</p>';
            else html += '<p>üöö <strong>‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á</strong> ' + promoSettings.shipping.cost + '‡∏ø</p>';
            let depositText = '';
            switch (promoSettings.deposit.type) {
                case 'price3': depositText = '‡∏£‡∏≤‡∏Ñ‡∏≤ 3 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏î'; break;
                case 'price1': depositText = '‡∏£‡∏≤‡∏Ñ‡∏≤ 1 ‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏ä‡∏∏‡∏î'; break;
                case 'fixed': depositText = promoSettings.deposit.fixedAmount + '‡∏ø ‡∏ï‡πà‡∏≠‡∏ä‡∏∏‡∏î'; break;
                case 'percent': depositText = promoSettings.deposit.percent + '% ‡∏Ç‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤'; break;
            }
            html += '<p>üí∞ <strong>‡∏°‡∏±‡∏î‡∏à‡∏≥</strong> = ' + depositText + '</p>';
            if (promoSettings.extraDiscounts.length > 0) {
                html += '<hr style="border-color:var(--border);margin:15px 0;"><p style="color:var(--accent);"><strong>‚ú® ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ:</strong></p>';
                promoSettings.extraDiscounts.forEach(d => { html += '<p>‚Ä¢ ' + d.name + ': ' + d.value + (d.type === 'percent' ? '%' : '‡∏ø') + '</p>'; });
            }
            html += '</div>';
            document.getElementById('currentRulesDisplay').innerHTML = html;
        }
        
        function renderActivePromos() {
            let tags = [];
            if (promoSettings.multiDress.enabled) tags.push('‡πÄ‡∏ä‡πà‡∏≤ ' + promoSettings.multiDress.minQty + '+ ‡∏ä‡∏∏‡∏î ‡∏•‡∏î ' + promoSettings.multiDress.discount + '%');
            if (promoSettings.oldCustomer.enabled) tags.push('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ ‡∏•‡∏î ' + promoSettings.oldCustomer.discount + '%');
            if (promoSettings.shipping.enabled) tags.push('‡∏™‡πà‡∏á‡∏ü‡∏£‡∏µ ' + promoSettings.shipping.freeQty + '+ ‡∏ä‡∏∏‡∏î');
            document.getElementById('activePromoTags').innerHTML = tags.length > 0 ? tags.map(t => '<span class="active-promo-tag">' + t + '</span>').join('') : '<span style="color:var(--text-secondary);">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
        }
        
        function renderExtraDiscountCheckboxes() {
            const container = document.getElementById('extraDiscountOptions');
            const wrapper = document.getElementById('extraDiscountCheckboxes');
            if (promoSettings.extraDiscounts.length === 0) { wrapper.style.display = 'none'; return; }
            wrapper.style.display = 'block';
            container.innerHTML = promoSettings.extraDiscounts.map((d, idx) => '<label style="display:flex;align-items:center;gap:10px;padding:8px 0;cursor:pointer;"><input type="checkbox" onchange="toggleExtraDiscountSelection(' + idx + ')"' + (selectedExtraDiscounts.includes(idx) ? ' checked' : '') + '><span>' + d.name + ' (' + d.value + (d.type === 'percent' ? '%' : '‡∏ø') + ')</span></label>').join('');
        }
        
        function toggleExtraDiscountSelection(idx) {
            const i = selectedExtraDiscounts.indexOf(idx);
            if (i > -1) selectedExtraDiscounts.splice(i, 1);
            else selectedExtraDiscounts.push(idx);
            calculatePrice();
        }
        
        function calculatePrice() {
            const resultDiv = document.getElementById('priceResult');
            if (!selectedDressesForCalc.length) { resultDiv.style.display = 'none'; return; }
            resultDiv.style.display = 'block';
            
            const days = parseInt(document.getElementById('calcDays').value);
            const isOldCustomer = document.getElementById('calcOldCustomer').value === 'true';
            
            let subtotal = 0, depositTotal = 0;
            selectedDressesForCalc.forEach(code => {
                const dress = dresses.find(d => d.code === code);
                if (dress) {
                    const price = days === 1 ? dress.price1 : days === 3 ? dress.price3 : dress.price5;
                    subtotal += price;
                    switch (promoSettings.deposit.type) {
                        case 'price3': depositTotal += dress.price3; break;
                        case 'price1': depositTotal += dress.price1; break;
                        case 'fixed': depositTotal += promoSettings.deposit.fixedAmount; break;
                    }
                }
            });
            if (promoSettings.deposit.type === 'percent') depositTotal = Math.round(subtotal * promoSettings.deposit.percent / 100);
            
            let discounts = [], totalDiscount = 0;
            if (promoSettings.multiDress.enabled && selectedDressesForCalc.length >= promoSettings.multiDress.minQty) {
                const amount = Math.round(subtotal * promoSettings.multiDress.discount / 100);
                discounts.push({ label: '‡∏•‡∏î‡πÄ‡∏ä‡πà‡∏≤ ' + promoSettings.multiDress.minQty + '+ ‡∏ä‡∏∏‡∏î (' + promoSettings.multiDress.discount + '%)', amount });
                totalDiscount += amount;
            }
            if (promoSettings.oldCustomer.enabled && isOldCustomer) {
                const amount = Math.round(subtotal * promoSettings.oldCustomer.discount / 100);
                discounts.push({ label: '‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤ (' + promoSettings.oldCustomer.discount + '%)', amount });
                totalDiscount += amount;
            }
            selectedExtraDiscounts.forEach(idx => {
                const d = promoSettings.extraDiscounts[idx];
                if (d) {
                    const amount = d.type === 'percent' ? Math.round(subtotal * d.value / 100) : d.value;
                    discounts.push({ label: d.name + ' (' + d.value + (d.type === 'percent' ? '%' : '‡∏ø') + ')', amount });
                    totalDiscount += amount;
                }
            });
            
            let shipping = promoSettings.shipping.cost;
            if (isFreeShipping || (promoSettings.shipping.enabled && selectedDressesForCalc.length >= promoSettings.shipping.freeQty)) shipping = 0;
            
            // ‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥
            if (isFreeDeposit) depositTotal = 0;
            
            const rentalTotal = Math.max(0, subtotal - totalDiscount + shipping);
            const grandTotal = rentalTotal + depositTotal;
            
            document.getElementById('priceSubtotal').textContent = subtotal.toLocaleString() + ' ‡∏ø';
            document.getElementById('discountRows').innerHTML = discounts.map(d => '<div class="price-row"><span class="price-label">' + d.label + '</span><span class="price-value" style="color:var(--success);">-' + d.amount.toLocaleString() + ' ‡∏ø</span></div>').join('');
            document.getElementById('priceShipping').textContent = shipping === 0 ? '‡∏ü‡∏£‡∏µ! üéâ' : shipping + ' ‡∏ø';
            document.getElementById('priceRental').textContent = rentalTotal.toLocaleString() + ' ‡∏ø';
            document.getElementById('priceDeposit').textContent = isFreeDeposit ? '‡∏ü‡∏£‡∏µ! üéâ' : depositTotal.toLocaleString() + ' ‡∏ø';
            document.getElementById('priceDeposit').style.color = isFreeDeposit ? 'var(--success)' : '';
            document.getElementById('priceTotal').textContent = grandTotal.toLocaleString() + ' ‡∏ø';
            
            let depositLabel = '‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥';
            switch (promoSettings.deposit.type) {
                case 'price3': depositLabel += ' (‡∏£‡∏≤‡∏Ñ‡∏≤ 3 ‡∏ß‡∏±‡∏ô)'; break;
                case 'price1': depositLabel += ' (‡∏£‡∏≤‡∏Ñ‡∏≤ 1 ‡∏ß‡∏±‡∏ô)'; break;
                case 'fixed': depositLabel += ' (' + promoSettings.deposit.fixedAmount + '‡∏ø/‡∏ä‡∏∏‡∏î)'; break;
                case 'percent': depositLabel += ' (' + promoSettings.deposit.percent + '%)'; break;
            }
            document.getElementById('depositLabel').textContent = depositLabel;
        }
        
        function showPage(page, btn) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
        }
        
        function changeGlobalMonth(delta) {
            globalMonth += delta;
            if (globalMonth > 11) { globalMonth = 0; globalYear++; }
            else if (globalMonth < 0) { globalMonth = 11; globalYear--; }
            renderCalendars();
        }
        
        function filterCalendars() { renderCalendars(); }
        function filterBlocks() { renderBlocksList(); }
        
        async function refreshAll() {
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...', 'info');
            await init();
            showToast('‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        
        function formatDate(date) {
            const d = new Date(date);
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }
        
        function formatDateThai(dateStr) {
            const d = new Date(dateStr);
            const months = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
            return d.getDate() + ' ' + months[d.getMonth()] + ' ' + (d.getFullYear() + 543);
        }
        
        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<span>' + (type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è') + '</span><span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'slideIn 0.3s reverse'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        init();
    </script>
</body>
</html>
